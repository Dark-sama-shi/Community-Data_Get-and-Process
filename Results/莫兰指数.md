# 数据初始化：各个城市平均房价
```python
from Tools import * #已经导入了numpy和pandas
import os
import csv
from bs4 import BeautifulSoup#用来解析获得的html代码
from urllib import request#用来访问网页
from urllib.request import urlopen#用来访问网页
headers={'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36 Edg/97.0.1072.55'}
```
```python
# 获取当前拥有的所有表格标题
name_li=os.listdir('info')
name_li
```
```python
# 数据初始化：加上城市标签、拼接、为后续删除无效信息做准备
data_dict={name_li[i][:-9]:pd.read_csv('info/%s'%name_li[i],encoding='gb18030') for i in range(len(name_li))}
for i in range(len(name_li)):
    data_dict[name_li[i][:-9]]['城市']=name_li[i][:-9]
    try:
        data_dict[name_li[i][:-9]]['建筑年代']=='abc'
    except:
        data_dict[name_li[i][:-9]]['建筑年代']='无信息'
df=data_dict['上海']
for i in range(len(name_li)-1):
    df=df.append(data_dict[name_li[i+1][:-9]])
df.reset_index(drop=True,inplace=True)
df.dropna(inplace=True)
df.reset_index(drop=True,inplace=True)
df['参考价格']=tuple(str(i) for i in df['参考价格'])
df.sort_values(by='参考价格',ascending=False,inplace=True)
df.reset_index(drop=True,inplace=True)
df
```
```python
# 看要从哪开始保留
for i in range(len(df)):
    if not df['参考价格'][i]=='当前网页找不到元素（价格）':
        print(i)
        break
```
```python
# 保留有房价的部分，房价数据类型变整数，排序
df=df[24982:]
df.reset_index(drop=True,inplace=True)
df['参考价格']=tuple(round(float(i)) for i in df['参考价格'])
df.sort_values(by=['城市','参考价格'],ascending=True,inplace=True)
df.reset_index(drop=True,inplace=True)
df
```
```python
print('%i, %i'%(min(df['参考价格']),max(df['参考价格'])))
```
```python
# 给每个城市算平均房价。第一步：初始化“房屋总数”变量
df['房屋总数']=tuple(max(int(i[:-1]),1) for i in df['房屋总数'])
df
```
```python
print('%i, %i'%(min(df['房屋总数']),max(df['房屋总数'])))
```
```python
# 给每个城市算平均房价。第二步：计算。公式：城市平均房价=sum(参考价格*房屋总数)/sum(房屋总数)
info=pd.DataFrame({'城市':tuple(set(df['城市']))})
info['平均价格']=''
for i in range(len(info)):
    temp=df[df['城市']==info['城市'][i]]
    temp['sum']=temp['参考价格']*temp['房屋总数']
    info['平均价格'][i]=round(sum(temp['sum'])/sum(temp['房屋总数']))
df['sum']=df['参考价格']*df['房屋总数']
X_bar=round(sum(df['sum'])/sum(df['房屋总数']))
del temp
info.sort_values(by='平均价格',ascending=False,inplace=True)
info.reset_index(drop=True,inplace=True)
info
```
```python
X_bar
```
```python
# 展示一下各个城市的平均房价
for i in range(len(info)):
    print('%s, %i'%(info['城市'][i],info['平均价格'][i]))
```
# 获取信息：各城市经纬度
>资源网站：[城市地区经纬度查询](https://jingwei.supfree.net/)
```python
# 从类似sitemap网站获取各城市网站链接
home='https://jingwei.supfree.net'
req=request.Request(url=home,headers=headers) #定义请求方式
string=request.urlopen(req).read().decode('gb18030')#请求访问
soup=BeautifulSoup(string,features='html.parser') #soup解析
city_li=tuple(str(i) for i in soup.findAll('a') if str(i)[9:15]=='kongzi')
city_href={i[29:-4]:home+'/'+i[9:27] for i in city_li}
del city_href['吉安???']
```
```python
city_href
```
```python
# 获取各城市经纬度
city_pos=dict()
for city,href in city_href.items():
    print('城市：%s，网站为：'%city)
    req=request.Request(url=href,headers=headers) #定义请求方式
    print(href)
    print('子网站为：')
    string=request.urlopen(req).read().decode('gb18030')#请求访问
    soup=BeautifulSoup(string,features='html.parser') #soup解析
    #这里应该需要一些re的技能，但我不会，所以笨办法
    next_href=home+'/'+BeautifulSoup(tuple(str(i) for i in soup.findAll('a') if str(i)[9:15]=='mengzi')[0]).find('a')['href']
    print(next_href)
    req=request.Request(url=next_href,headers=headers) #定义请求方式
    string=request.urlopen(req).read().decode('gb18030')#请求访问
    soup=BeautifulSoup(string,features='html.parser') #soup解析
    city_pos[city]=(float(soup.findAll('span',{'class':'bred botitle18'})[0].get_text()),float(soup.findAll('span',{'class':'bred botitle18'})[1].get_text()))
    print(float(soup.findAll('span',{'class':'bred botitle18'})[0].get_text()),float(soup.findAll('span',{'class':'bred botitle18'})[1].get_text()))
```
```python
# 写入经纬度信息到city_pos.csv，以便下次查阅
output=open('city_pos.csv','a',newline='',encoding='gb18030')
csv_write=csv.writer(output,dialect='excel')
csv_write.writerow(('城市','经度','纬度'))
for i in city_pos.keys():
    csv_write.writerow((i,city_pos[i][0],city_pos[i][1]))
output.close()
```
```python
# 读入并写入经纬度信息到平均房价表里
city_pos_df=pd.read_csv('city_pos.csv',encoding='gb18030')
info['经度']=''
info['纬度']=''
for i in range(len(info)):
    for j in range(len(city_pos_df)):
        if info['城市'][i] in city_pos_df['城市'][j]:
            info.iloc[i,2],info.iloc[i,3]=float(city_pos_df.iloc[j,1]),float(city_pos_df.iloc[j,2])
            break
# 还有两个（襄阳-襄樊，江阴-无锡下辖江阴）没匹配到，手动匹配一下
info.iloc[57,2]=112.15
info.iloc[57,3]=32.02
info.iloc[28,2]=120.27
info.iloc[28,3]=31.90
info
```
# 计算距离矩阵、权重矩阵
```python
# 示例：二维数组如何变成np.array求和（max也一样）
(np.array([[1,2,3],[2,3,4]])*np.array([[1,2,3],[2,3,4]])).sum()
```
```python
n=len(info)
Distance=tuple(tuple(itude_to_distance(info.iloc[i,2],info.iloc[i,3],info.iloc[j,2],info.iloc[j,3]) for j in range(n)) for i in range(n))
W=1/(np.array(Distance)*np.array(Distance))
for i in range(n):
    W[i][i]=0
    w_max=W[i].max()
    W[i]=(1/w_max)*W[i]
W=tuple(tuple(W[i]) for i in range(n))
print(W[0])
```
# 全局莫兰指数
## 计算全局莫兰指数
<img src="http://latex.codecogs.com/gif.latex?\left\{\begin{array}{l}I=\frac{n}{S_{0}}\frac{\sum_{i=1}^{n}\sum_{j=1}^{n}w_{i,j}z_{i}z_{j}}{\sum_{i=1}^{n}z_{i}^{2}}\\z_{i}=x_{i}-\bar{X}\\S_{0}=\sum_{i=1}^{n}\sum_{j=1}^{n}w_{i,j}\end{array}\right." />

```python
S_0=np.array(W).sum()
Z=tuple(info.iloc[i,1]-X_bar for i in range(n))
I=n/S_0*sum((W[i][j]*Z[i]*Z[j] for j in range(n) for i in range(n)))/sum((Z[i]**2 for i in range(n)))
print(I)
```
## 计算全局莫兰指数的$z_{I}$得分
<img src="http://latex.codecogs.com/gif.latex?\left\{\begin{array}{l}z_{I}=\frac{I-E[I]}{\sqrt{V[I]}}\\E[I]=\frac{-1}{n-1}\\V[I]=E[I^{2}]-E[I]^{2}\\E[I^{2}]=\frac{A-B}{C}\\A=n\left[\left(n^{2}-3n+3\right)S_{1}-nS_{2}+3S_{0}^{2}\right]\\B=D\left[\left(n^{2}-n\right)S_{1}-2nS_{2}+6S_{0}^{2}\right]\\C=(n-1)(n-2)(n-3)S_{0}^{2}\\D=\frac{\sum_{i=1}^{n}z_{i}^{4}}{\left(\sum_{i=1}^{n}z_{i}^{2}\right)^{2}}\\S_{1}=(1/2)\sum_{i=1}^{n}\sum_{j=1}^{n}\left(w_{i,j}+w_{j,i}\right)^{2}\\S_{2}=\sum_{i=1}^{n}\left(\sum_{j=1}^{n}w_{i,j}+\sum_{j=1}^{n}w_{j,i}\right)^{2}\end{array}\right." />
